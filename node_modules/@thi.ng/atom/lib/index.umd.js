!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@thi.ng/api"),require("@thi.ng/errors"),require("@thi.ng/paths"),require("@thi.ng/equiv"),require("@thi.ng/checks")):"function"==typeof define&&define.amd?define(["exports","@thi.ng/api","@thi.ng/errors","@thi.ng/paths","@thi.ng/equiv","@thi.ng/checks"],e):e(((t=t||self).thi=t.thi||{},t.thi.ng=t.thi.ng||{},t.thi.ng.atom={}),t.thi.ng.api,t.thi.ng.errors,t.thi.ng.paths,t.thi.ng.equiv,t.thi.ng.checks)}(this,(function(t,e,s,i,r,h){"use strict";let n=0;const a=()=>n++;class c{constructor(t,e,s,h=!0,n=r.equiv){this.parent=t,this.id=`view-${a()}`,this.tx=s||(t=>t),this.path=i.toPath(e),this.isDirty=!0,this.isLazy=h;const c=i.getter(this.path),u=this.parent.deref();this.unprocessed=u?c(u):void 0,h||(this.state=this.tx(this.unprocessed),this.unprocessed=void 0),t.addWatch(this.id,(t,e,s)=>{const i=e?c(e):e,r=s?c(s):s;n(r,i)||(h?this.unprocessed=r:this.state=this.tx(r),this.isDirty=!0)})}get value(){return this.deref()}deref(){return this.isDirty&&(this.isLazy&&(this.state=this.tx(this.unprocessed),this.unprocessed=void 0),this.isDirty=!1),this.state}changed(){return this.isDirty}view(){return this.isDirty&&this.isLazy?this.tx(this.unprocessed):this.state}release(){return this.unprocessed=void 0,this.isLazy||(this.state=this.tx(void 0)),this.isDirty=!0,this.parent.removeWatch(this.id)}}var u=function(t,e,s,i){var r,h=arguments.length,n=h<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,s,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(n=(h<3?r(n):h>3?r(e,s,n):r(e,s))||n);return h>3&&n&&Object.defineProperty(e,s,n),n};t.Atom=class{constructor(t,e){e&&!e(t)&&s.illegalState("initial state value did not validate"),this._value=t,this.valid=e}get value(){return this._value}set value(t){this.reset(t)}deref(){return this._value}equiv(t){return this===t}reset(t){const e=this._value;return this.valid&&!this.valid(t)?e:(this._value=t,this.notifyWatches(e,t),t)}resetIn(t,e){return this.reset(i.setIn(this._value,t,e))}swap(t,...e){return this.reset(t.apply(null,[this._value,...e]))}swapIn(t,e,...s){return this.reset(i.updateIn(this._value,t,e,...s))}addWatch(t,e){}removeWatch(t){}notifyWatches(t,e){}addView(t,e,s=!0){return new c(this,t,e,s)}release(){return delete this._watches,delete this._value,!0}},t.Atom=u([e.IWatchMixin],t.Atom);var o,d=function(t,e,s,i){var r,h=arguments.length,n=h<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,s,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(n=(h<3?r(n):h>3?r(e,s,n):r(e,s))||n);return h>3&&n&&Object.defineProperty(e,s,n),n};t.History=o=class{constructor(t,e=100,s){this.state=t,this.maxLen=e,this.changed=s||((t,e)=>!r.equiv(t,e)),this.clear()}get value(){return this.deref()}set value(t){this.reset(t)}canUndo(){return this.history.length>0}canRedo(){return this.future.length>0}clear(){this.history=[],this.future=[]}undo(){if(this.history.length){const t=this.state.deref();this.future.push(t);const e=this.state.reset(this.history.pop());return this.notify({id:o.EVENT_UNDO,value:{prev:t,curr:e}}),e}}redo(){if(this.future.length){const t=this.state.deref();this.history.push(t);const e=this.state.reset(this.future.pop());return this.notify({id:o.EVENT_REDO,value:{prev:t,curr:e}}),e}}reset(t){const e=this.state.deref();return this.state.reset(t),this.changed(e,this.state.deref())&&this.record(e),t}resetIn(t,e){const s=this.state.deref(),r=i.getIn(s,t),h=i.setIn(s,t,e);return this.state.reset(h),this.changed(r,i.getIn(h,t))&&this.record(s),h}swap(t,...e){return this.reset(t(this.state.deref(),...e))}swapIn(t,e,...s){const r=this.state.deref(),h=i.getIn(r,t),n=i.updateIn(this.state.deref(),t,e,...s);return this.state.reset(n),this.changed(h,i.getIn(n,t))&&this.record(r),n}record(t){const e=this.history,s=e.length;let i=!0;arguments.length||(t=this.state.deref(),i=!s||this.changed(e[s-1],t)),i&&(s>=this.maxLen&&e.shift(),e.push(t),this.notify({id:o.EVENT_RECORD,value:t}),this.future.length=0)}deref(){return this.state.deref()}addWatch(t,e){return this.state.addWatch(t,e)}removeWatch(t){return this.state.removeWatch(t)}notifyWatches(t,e){return this.state.notifyWatches(t,e)}addView(t,e,s=!0){return new c(this,t,e,s)}release(){return this.state.release(),delete this.state,!0}addListener(t,e,s){}removeListener(t,e,s){}notify(t){}},t.History.EVENT_UNDO="undo",t.History.EVENT_REDO="redo",t.History.EVENT_RECORD="record",t.History=o=d([e.INotifyMixin],t.History);t.Cursor=class{constructor(...e){let r,n,c,u,o,d;switch(e.length){case 1:o=e[0],d=o.id,r=o.parent,u=o.validate,o.path?h.isArray(o.path)&&h.isFunction(o.path[0])?[n,c]=o.path:(n=i.getter(o.path),c=i.setter(o.path)):s.illegalArgs("missing path config");break;case 2:r=e[0],n=i.getter(e[1]),c=i.setter(e[1]);break;case 3:[r,n,c]=e;break;default:s.illegalArity(e.length)}this.parent=r,this.id=d||`cursor-${a()}`,this.selfUpdate=!1,n&&c||s.illegalArgs(),this.local=new t.Atom(n(r.deref()),u),this.local.addWatch(this.id,(t,e,s)=>{e!==s&&(this.selfUpdate=!0,r.swap(t=>c(t,s)),this.selfUpdate=!1)}),r.addWatch(this.id,(t,e,s)=>{if(!this.selfUpdate){const t=n(s);t!==n(e)&&this.local.reset(t)}})}get value(){return this.deref()}set value(t){this.reset(t)}deref(){return this.local.deref()}release(){return this.local.release(),this.parent.removeWatch(this.id),delete this.local,delete this.parent,!0}reset(t){return this.local.reset(t)}resetIn(t,e){return this.local.resetIn(t,e)}swap(t,...e){return this.local.swap(t,...e)}swapIn(t,e,...s){return this.local.swapIn(t,e,...s)}addWatch(t,e){return this.local.addWatch(t,e)}removeWatch(t){return this.local.removeWatch(t)}notifyWatches(t,e){return this.local.notifyWatches(t,e)}addView(t,e,s=!0){return new c(this,t,e,s)}},t.Transacted=class{constructor(t){this.parent=t,this.current=void 0,this.isActive=!1,this.id=`tx${a()}-`}get value(){return this.deref()}set value(t){this.reset(t)}get isTransaction(){return this.isActive}deref(){return this.isActive?this.current:this.parent.deref()}equiv(t){return this===t}reset(t){return this.ensureTx(),this.current=t,t}resetIn(t,e){return this.ensureTx(),this.reset(i.setIn(this.current,t,e))}swap(t,...e){return this.ensureTx(),this.reset(t.apply(null,[this.current,...e]))}swapIn(t,e,...s){return this.ensureTx(),this.reset(i.updateIn(this.current,t,e,...s))}begin(){e.assert(!this.isActive,"transaction already started"),this.current=this.parent.deref(),this.isActive=!0}commit(){this.ensureTx();const t=this.current;return this.parent.reset(this.current),this.isActive=!1,this.current=void 0,t}cancel(){this.ensureTx(),this.isActive=!1,this.current=void 0}addWatch(t,e){return this.parent.addWatch(this.id+t,(s,i,r)=>e(t,i,r))}removeWatch(t){return this.parent.removeWatch(this.id+t)}notifyWatches(t,e){this.parent.notifyWatches(t,e)}addView(t,e,s=!0){return new c(this,t,e,s)}release(){return delete this.parent,delete this.current,delete this.isActive,delete this._watches,!0}ensureTx(){e.assert(this.isActive,"no active transaction")}},t.View=c,Object.defineProperty(t,"__esModule",{value:!0})}));