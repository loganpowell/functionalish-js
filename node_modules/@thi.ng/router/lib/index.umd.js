!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@thi.ng/api"),require("@thi.ng/checks"),require("@thi.ng/equiv"),require("@thi.ng/errors")):"function"==typeof define&&define.amd?define(["exports","@thi.ng/api","@thi.ng/checks","@thi.ng/equiv","@thi.ng/errors"],e):e(((t=t||self).thi=t.thi||{},t.thi.ng=t.thi.ng||{},t.thi.ng.router={}),t.thi.ng.api,t.thi.ng.checks,t.thi.ng.equiv,t.thi.ng.errors)}(this,(function(t,e,i,r,n){"use strict";var s=function(t,e,i,r){var n,s=arguments.length,a=s<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var o=t.length-1;o>=0;o--)(n=t[o])&&(a=(s<3?n(a):s>3?n(e,i,a):n(e,i))||a);return s>3&&a&&Object.defineProperty(e,i,a),a};t.BasicRouter=class{constructor(t){if(t.authenticator=t.authenticator||((t,e,i)=>({id:t.id,title:t.title,params:i})),t.prefix=void 0===t.prefix?"/":t.prefix,t.separator=t.separator||"/",this.config=t,e.assert(void 0!==this.routeForID(this.config.defaultRouteID),`missing config for default route: '${this.config.defaultRouteID}'`),t.initialRouteID){const i=this.routeForID(t.initialRouteID);e.assert(void 0!==i,`missing config for initial route: ${this.config.initialRouteID}`),e.assert(!a(i),"initial route MUST not be parametric")}}addListener(t,e,i){}removeListener(t,e,i){}notify(t){}start(){if(this.config.initialRouteID){const t=this.routeForID(this.config.initialRouteID);this.current={id:t.id,title:t.title,params:{}},this.notify({id:"route-changed",value:this.current})}}route(t){"#"===t.charAt(0)&&(t=t.substr(1)),t=t.substr(this.config.prefix.length);const e=this.config.routes,i=t.split(this.config.separator);let n;for(let t=0,r=e.length;t<r;t++){const r=e[t],s=this.matchRoute(i,r);if(s){n=s;break}}if(!n){if(!this.handleRouteFailure())return;const t=this.routeForID(this.config.defaultRouteID);n={id:t.id,title:t.title,params:{}}}return r.equiv(n,this.current)||(this.current=n,this.notify({id:"route-changed",value:n})),n}format(...t){let e,[r,s,a]=t;switch(t.length){case 3:e={id:r,params:s};break;case 2:i.isString(r)?e={id:r,params:s}:(a=s,e=r);break;case 1:e=i.isString(r)?{id:r}:r;break;default:n.illegalArity(t.length)}const o=this.routeForID(e.id);if(o){const t=e.params||{};return(a?"#":"")+this.config.prefix+o.match.map(e=>"?"===e.charAt(0)?null!=(e=t[e.substr(1)])?e:"NULL":e).join(this.config.separator)}n.illegalArgs(`invalid route ID: ${e.id}`)}routeForID(t){return this.config.routes.find(e=>e.id===t)}matchRoute(t,e){const i=e.match,r=i.length;if(t.length===r){const n={};for(let e=0;e<r;e++){const r=i[e];if("?"===r.charAt(0))n[r.substr(1)]=t[e];else if(t[e]!==r)return}if(e.validate&&!this.validateRouteParams(n,e.validate))return;return e.auth?this.config.authenticator(e,t,n):{id:e.id,title:e.title,params:n}}}validateRouteParams(t,e){for(let i in e)if(void 0!==t[i]){const r=e[i];if(r.coerce&&(t[i]=r.coerce(t[i])),r.check&&!r.check(t[i]))return!1}return!0}handleRouteFailure(){return!0}},t.BasicRouter=s([e.INotifyMixin],t.BasicRouter);const a=t=>t.match.some(t=>"?"===t.charAt(0));class o extends t.BasicRouter{constructor(t){super(t),this.useFragment=!1!==t.useFragment,this.ignoreHashChange=!1}start(){if(window.addEventListener("popstate",this.handlePopChange()),this.useFragment&&window.addEventListener("hashchange",this.handleHashChange()),this.config.initialRouteID){const t=this.routeForID(this.config.initialRouteID);this.route(this.format({id:t.id,title:t.title}))}else this.route(this.useFragment?location.hash:location.pathname)}release(){window.removeEventListener("popstate",this.popHandler),this.useFragment&&window.removeEventListener("hashchange",this.hashHandler)}route(t,e=!0){const i=this.current,n=super.route(t);return n&&!r.equiv(n,i)&&(this.currentPath=this.format(n),e&&history.pushState(this.currentPath,n.title||window.document.title||"",this.currentPath)),n}routeTo(t){this.useFragment&&(location.hash=t),this.route(t)}format(...t){let e;switch(t.length){case 2:e={id:t[0],params:t[1]};break;case 1:e=i.isString(t[0])?{id:t[0]}:t[0];break;default:n.illegalArity(t.length)}return super.format(e,this.useFragment)}handlePopChange(){return this.popHandler=this.popHandler||(t=>{this.route(t.state||(this.useFragment?location.hash:location.pathname),!1)}).bind(this)}handleHashChange(){return this.hashHandler=this.hashHandler||(t=>{if(!this.ignoreHashChange){const e=t.newURL.substr(t.newURL.indexOf("#"));e!==this.currentPath&&this.route(e,!1)}}).bind(this)}handleRouteFailure(){return this.ignoreHashChange=!0,location.hash=this.format({id:this.routeForID(this.config.defaultRouteID).id}),this.ignoreHashChange=!1,!0}}t.EVENT_ROUTE_CHANGED="route-changed",t.EVENT_ROUTE_FAILED="route-failed",t.HTMLRouter=o,Object.defineProperty(t,"__esModule",{value:!0})}));