import { LOGGER, Stream } from "@thi.ng/rstream";
/**
 * Returns a stream of values received from given
 * {@link @thi.ng/csp#Channel}.
 *
 * @param src -
 * @param opts -
 */
export const fromChannel = (src, opts) => {
    opts = { id: `channel-${src.id}`, closeChannel: true, ...opts };
    return new Stream((stream) => {
        let isActive = true;
        (async () => {
            let x;
            while (((x = null), (x = await src.read())) !== undefined) {
                if (x === undefined || !isActive) {
                    break;
                }
                stream.next(x);
            }
            stream.done();
        })();
        return () => {
            if (opts.closeChannel !== false) {
                src.close(true);
                LOGGER.info("closed channel", src.id);
            }
            isActive = false;
        };
    }, opts);
};
