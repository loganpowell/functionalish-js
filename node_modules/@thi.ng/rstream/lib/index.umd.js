!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@thi.ng/api"),require("@thi.ng/transducers"),require("@thi.ng/checks"),require("@thi.ng/arrays"),require("@thi.ng/errors"),require("@thi.ng/associative"),require("@thi.ng/atom")):"function"==typeof define&&define.amd?define(["exports","@thi.ng/api","@thi.ng/transducers","@thi.ng/checks","@thi.ng/arrays","@thi.ng/errors","@thi.ng/associative","@thi.ng/atom"],t):t(((e=e||self).thi=e.thi||{},e.thi.ng=e.thi.ng||{},e.thi.ng.rstream={}),e.thi.ng.api,e.thi.ng.transducers,e.thi.ng.checks,e.arrays,e.thi.ng.errors,e.thi.ng.associative,e.thi.ng.atom)}(this,(function(e,t,s,r,i,n,o,c){"use strict";var u,a;(u=e.State||(e.State={}))[u.IDLE=0]="IDLE",u[u.ACTIVE=1]="ACTIVE",u[u.DONE=2]="DONE",u[u.ERROR=3]="ERROR",u[u.DISABLED=4]="DISABLED",(a=e.CloseMode||(e.CloseMode={}))[a.NEVER=0]="NEVER",a[a.FIRST=1]="FIRST",a[a.LAST=2]="LAST",e.LOGGER=t.NULL_LOGGER;let h=0;const l=()=>h++,d=(e,t)=>t&&t.id?t:Object.assign(Object.assign({},t),{id:e+"-"+l()}),b=(e,t)=>new m(e,t);class m{constructor(e,r={}){this.state=0,this.parent=r.parent,this.closeIn=void 0!==r.closeIn?r.closeIn:2,this.closeOut=void 0!==r.closeOut?r.closeOut:2,this.cacheLast=!1!==r.cache,this.id=r.id||`sub-${l()}`,this.last=t.SEMAPHORE,this.subs=[],e&&this.subs.push(e),r.xform&&(this.xform=r.xform(s.push()))}deref(){return this.last!==t.SEMAPHORE?this.last:void 0}getState(){return this.state}subscribe(...e){let s;this.ensureState();let o=e.length>1&&r.isPlainObject(i.peek(e))?Object.assign({},e.pop()):{};switch(e.length){case 1:r.isFunction(e[0])?(o.xform=e[0],!o.id&&(o.id=`xform-${l()}`)):s=e[0];break;case 2:s=e[0],o.xform=e[1];break;default:n.illegalArity(e.length)}return r.implementsFunction(s,"subscribe")?s.parent=this:s=b(s,Object.assign({parent:this},o)),this.last!==t.SEMAPHORE&&s.next(this.last),this.addWrapped(s)}subscribeAll(...e){const t=[];for(let s of e)t.push(this.subscribe(s));return t}transform(...e){const t=e.length-1;return r.isPlainObject(e[t])?this.subscribe(s.comp(...e.slice(0,t)),e[t]):this.subscribe(s.comp(...e))}unsubscribe(t){if(e.LOGGER.debug(this.id,"unsub start",t?t.id:"self"),!t){let e=!0;return this.parent&&(e=this.parent.unsubscribe(this)),this.state=2,this.cleanup(),e}if(this.subs){e.LOGGER.debug(this.id,"unsub child",t.id);const s=this.subs.indexOf(t);if(s>=0)return this.subs.splice(s,1),(1===this.closeOut||!this.subs.length&&0!==this.closeOut)&&this.unsubscribe(),!0}return!1}next(e){if(this.state<2)if(this.xform){const t=this.xform[2]([],e),r=s.unreduced(t),i=r.length;for(let e=0;e<i;e++)this.dispatch(r[e]);s.isReduced(t)&&this.done()}else this.dispatch(e)}done(){if(e.LOGGER.debug(this.id,"entering done()"),this.state<2){if(this.xform){const e=this.xform[1]([]),t=s.unreduced(e),r=t.length;for(let e=0;e<r;e++)this.dispatch(t[e])}this.state=2;for(let e of[...this.subs])try{e.done&&e.done()}catch(t){e.error?e.error(t):this.error(t)}this.unsubscribe(),e.LOGGER.debug(this.id,"exiting done()")}}error(t){this.state=3;let s=!1;if(this.subs&&this.subs.length)for(let e of this.subs.slice())e.error&&(e.error(t),s=!0);s||(e.LOGGER.warn(this.id,"unhandled error:",t),this.parent&&(e.LOGGER.debug(this.id,"unsubscribing..."),this.unsubscribe(),this.state=3))}addWrapped(e){return this.subs.push(e),this.state=1,e}dispatch(e){this.cacheLast&&(this.last=e);const t=this.subs;let s;if(1===t.length){s=t[0];try{s.next&&s.next(e)}catch(e){s.error?s.error(e):this.error(e)}}else for(let r=t.length;--r>=0;){s=t[r];try{s.next&&s.next(e)}catch(e){s.error?s.error(e):this.error(e)}}}ensureState(){this.state>=2&&n.illegalState(`operation not allowed in state ${this.state}`)}cleanup(){e.LOGGER.debug(this.id,"cleanup"),this.subs.length=0,delete this.parent,delete this.xform,delete this.last}}const f=e=>new p(e);class p extends m{constructor(e){const t=new Set,r=s.partitionSync(t,{key:e=>e[0],mergeOnly:!0===e.mergeOnly,reset:!0===e.reset,all:!1!==e.all,backPressure:e.backPressure||0}),i=s.mapVals(e=>e[1]);super(void 0,d("streamsync",Object.assign(Object.assign({},e),{xform:e.xform?s.comp(r,i,e.xform):s.comp(r,i)}))),this.sources=new Map,this.realSourceIDs=new Map,this.invRealSourceIDs=new Map,this.idSources=new Map,this.sourceIDs=t,e.src&&this.addAll(e.src)}add(e,t){t||(t=e.id),this.ensureState(),this.sourceIDs.add(t),this.realSourceIDs.set(t,e.id),this.invRealSourceIDs.set(e.id,t),this.idSources.set(e.id,e),this.sources.set(e,e.subscribe({next:e=>{e[1]instanceof m?this.add(e[1]):this.next(e)},done:()=>this.markDone(e),__owner:this},s.labeled(t),{id:`in-${t}`}))}addAll(e){if(r.isPlainObject(e)){for(let t in e)this.sourceIDs.add(t);for(let t in e)this.add(e[t],t)}else{for(let t of e)this.sourceIDs.add(t.id);for(let t of e)this.add(t)}}remove(t){const s=this.sources.get(t);if(s){const r=this.invRealSourceIDs.get(t.id);return e.LOGGER.info(`removing src: ${t.id} (${r})`),this.sourceIDs.delete(r),this.realSourceIDs.delete(r),this.invRealSourceIDs.delete(t.id),this.idSources.delete(t.id),this.sources.delete(t),s.unsubscribe(),!0}return!1}removeID(e){const t=this.getSourceForID(e);return!!t&&this.remove(t)}removeAll(e){for(let t of e)this.sourceIDs.delete(this.invRealSourceIDs.get(t.id));let t=!0;for(let s of e)t=this.remove(s)&&t;return t}removeAllIDs(e){let t=!0;for(let s of e)t=this.removeID(s)&&t;return t}getSourceForID(e){return this.idSources.get(this.realSourceIDs.get(e))}getSources(){const e={};for(let[t,s]of this.idSources)e[this.invRealSourceIDs.get(t)]=s;return e}unsubscribe(e){if(!e){for(let e of this.sources.values())e.unsubscribe();this.state=2,this.sources.clear(),this.sourceIDs.clear(),this.realSourceIDs.clear(),this.invRealSourceIDs.clear(),this.idSources.clear()}return super.unsubscribe(e)}markDone(e){this.remove(e),(1===this.closeIn||2===this.closeIn&&!this.sources.size)&&this.done()}}const g=e=>e instanceof Worker?e:new Worker(e instanceof Blob?URL.createObjectURL(e):e),v=e=>new x(e);class x extends m{constructor(e){super(void 0,{id:e.id||`tunnel-${l()}`}),this.src=e.src,this.workers=new Array(e.maxWorkers||1),this.transferables=e.transferables,this.terminate=e.terminate||1e3,this.interrupt=e.interrupt||!1,this.index=0}next(e){if(this.state<2){let t;this.transferables&&(t=this.transferables(e));let s=this.workers[this.index];this.interrupt&&s&&(s.terminate(),s=null),s||(this.workers[this.index++]=s=g(this.src),this.index%=this.workers.length,s.addEventListener("message",e=>this.dispatch(e.data)),s.addEventListener("error",e=>this.error(e))),s.postMessage(e,t||[])}}done(){super.done(),this.terminate>0&&setTimeout(()=>{e.LOGGER.info("terminating workers..."),this.workers.forEach(e=>e&&e.terminate()),delete this.workers},this.terminate)}}class I extends m{constructor(e,t){super(void 0,d("metastram",t)),this.factory=e}next(e){if(this.state<2){this.stream&&this.stream.unsubscribe(this.sub);let t=this.factory(e);t&&(this.stream=t,this.sub=this.stream.subscribe({next:e=>{t===this.stream&&super.dispatch(e)},done:()=>{this.stream.unsubscribe(this.sub),t===this.stream&&(this.stream=void 0,this.sub=void 0)},error:e=>super.error(e),__owner:this}))}}done(){this.stream&&this.detach(),super.done()}unsubscribe(e){return!this.stream||e&&1!==this.subs.length||this.detach(),super.unsubscribe()}detach(){t.assert(!!this.stream,"input stream already removed"),this.stream.unsubscribe(this.sub),delete this.stream,delete this.sub}}class S extends m{constructor(e){super(void 0,d("pubsub",{xform:(e=e||{}).xform})),this.topicfn=e.topic,this.topics=new o.EquivMap(void 0,{equiv:e.equiv})}subscribe(){return n.unsupported("use subscribeTopic() instead")}transform(){return n.unsupported("use subscribeTopic() instead")}subscribeTopic(e,t,s){let r=this.topics.get(e);return!r&&this.topics.set(e,r=b()),r.subscribe(t,s)}unsubscribeTopic(e,t){const s=this.topics.get(e);return!!s&&s.unsubscribe(t)}unsubscribe(e){if(!e){for(let e of this.topics.values())e.unsubscribe();return this.topics.clear(),super.unsubscribe()}return n.unsupported()}done(){for(let e of this.topics.values())e.done();super.done()}dispatch(t){e.LOGGER.debug(this.id,"dispatch",t);const s=this.topicfn(t);if(void 0!==s){const e=this.topics.get(s);if(e)try{e.next&&e.next(t)}catch(t){e.error?e.error(t):this.error(t)}}}}class w extends m{constructor(e,t){const[s,i]=r.isFunction(e)?[e,t]:[void 0,e];super(void 0,d("stream",i)),this.src=s,this._inited=!1}subscribe(...e){const t=super.subscribe.apply(this,e);return this._inited||(this._cancel=this.src&&this.src(this)||(()=>{}),this._inited=!0),t}unsubscribe(e){const t=super.unsubscribe(e);return!t||e&&(this.subs&&this.subs.length||0===this.closeOut)||this.cancel(),t}done(){this.cancel(),super.done(),delete this.src,delete this._cancel}error(e){super.error(e),this.cancel()}cancel(){if(this._cancel){e.LOGGER.debug(this.id,"cancel");const t=this._cancel;delete this._cancel,t()}}}class E extends m{constructor(e){super(void 0,d("streammerge",e=e||{})),this.sources=new Map,e.src&&this.addAll(e.src)}add(e){this.ensureState(),this.sources.set(e,e.subscribe({next:e=>{e instanceof m?this.add(e):this.next(e)},done:()=>this.markDone(e),__owner:this},{id:`in-${e.id}`}))}addAll(e){for(let t of e)this.add(t)}remove(e){const t=this.sources.get(e);return!!t&&(this.sources.delete(e),t.unsubscribe(),!0)}removeID(e){for(let t of this.sources)if(t[0].id===e)return this.remove(t[0]);return!1}removeAll(e){let t=!0;for(let s of e)t=this.remove(s)&&t;return t}removeAllIDs(e){let t=!0;for(let s of e)t=this.removeID(s)&&t;return t}unsubscribe(e){if(!e){for(let e of this.sources.values())e.unsubscribe();this.state=2,this.sources.clear()}return super.unsubscribe(e)}markDone(e){this.remove(e),(1===this.closeIn||2===this.closeIn&&!this.sources.size)&&this.done()}}const O=(e,t={})=>new w(s=>{const r=e[Symbol.iterator](),i=setInterval(()=>{let e;(e=r.next()).done?(clearInterval(i),0!==s.closeIn&&s.done()):s.next(e.value)},t.delay||0);return()=>clearInterval(i)},d("iterable",t));const R=(e,t)=>(t=d("interval",Object.assign({num:1/0},t)),new w(s=>{let r=0,i=t.num;s.next(r++);let n=setInterval(()=>{s.next(r++),--i<=0&&(clearInterval(n),0!==s.closeIn&&s.done())},e);return()=>clearInterval(n)},t)),D=e=>r.isNode()?R(16,e):new w(e=>{let t=0,s=!0,r=()=>{s&&e.next(t++),s&&(i=requestAnimationFrame(r))},i=requestAnimationFrame(r);return()=>{s=!1,cancelAnimationFrame(i)}},d("raf",e)),k=(e,t,i,n,o)=>f({src:{src:e,_:null==o?D():r.isNumber(o)?R(o):o},closeIn:1}).transform(s.scan(s.reducer(()=>t,(e,{src:t})=>i(e,t))),s.dedupe(n||(()=>!1))),L=(e,t,s=!1,r)=>new w(r=>{let i=e=>r.next(e);return e.addEventListener(t,i,s),()=>e.removeEventListener(t,i,s)},d(`event-${t}`,r)),y=(e,t)=>{let s=!1,r=!1,i={};return e.catch(e=>{i=e,r=!0}),new w(t=>(e.then(e=>{!s&&t.getState()<2&&(r?(t.error(i),i=null):(t.next(e),0!==t.closeIn&&t.done()))},e=>t.error(e)),()=>{s=!0}),d("promise",t))};class G extends m{constructor(e){super(void 0,e)}unsubscribe(e){const t=super.unsubscribe(e);return e&&this.subs.length||this.sideSub.unsubscribe(),t}done(){this.sideSub.unsubscribe(),super.done()}}class A extends m{constructor(e={}){super(void 0,d("resolve")),this.outstanding=0,this.fail=e.fail}next(t){this.outstanding++,t.then(s=>{this.state<2?(this.dispatch(s),0==--this.outstanding&&this.done()):e.LOGGER.warn(`resolved value in state ${this.state} (${t})`)},e=>{this.fail?this.fail(e):this.error(e)})}done(){2===this.parent.getState()&&0===this.outstanding&&super.done()}}class T extends G{constructor(e,t){super(t=d("sidepart",t)),this.buf=[];const s=t.pred||(()=>!0),r=this;this.sideSub=e.subscribe({next(e){r.buf.length&&s(e)&&(r.dispatch(r.buf),r.buf=[])},done(){r.buf.length&&r.dispatch(r.buf),r.done(),delete r.buf}})}next(e){this.state<2&&this.buf.push(e)}}class M extends G{constructor(e,t){super(t=d("sidetoggle",t)),this.isActive=!!t.initial;const s=t.pred||(()=>!0),r=this;this.sideSub=e.subscribe({next(e){s(e)&&(r.isActive=!r.isActive)},done(){r.done()}})}next(e){this.isActive&&this.state<2&&super.next(e)}}class j extends m{constructor(e,t){super(void 0,t=d("timeout",t)),this.timeoutMs=e,this.errorObj=t.error,this.resetTimeout=!0===t.reset,this.reset()}next(e){this.resetTimeout&&(clearTimeout(this.timeoutId),this.reset()),super.next(e)}reset(){this.timeoutId=setTimeout(()=>{this.state<2&&this.error(this.errorObj||new Error(`Timeout stream "${this.id}" after ${this.timeoutMs} ms`))},this.timeoutMs)}cleanup(){clearTimeout(this.timeoutId),super.cleanup()}}e.ASidechain=G,e.MetaStream=I,e.PubSub=S,e.Resolver=A,e.SidechainPartition=T,e.SidechainToggle=M,e.Stream=w,e.StreamMerge=E,e.StreamSync=p,e.Subscription=m,e.Tunnel=x,e.bisect=(e,t,s)=>{const r=new S({topic:e});return t&&r.subscribeTopic(!0,t),s&&r.subscribeTopic(!1,s),r},e.forkBuffer=(e=1)=>(t,s,r)=>{const i=Math.max(e,r.length/s|0);return t<s-1?r.slice(t*i,(t+1)*i):r.slice(t*i)},e.forkJoin=e=>{const t=e.numWorkers||navigator.hardwareConcurrency||4,r=s.range(t);return f({src:[...s.map(r=>e.src.transform(s.map(s=>e.fork(r,t,s))).subscribe(v({src:e.worker,transferables:e.transferables,interrupt:!0===e.interrupt,terminate:e.terminate,id:String(r)})),r)],xform:s.comp(s.map(e=>[...s.map(t=>e[t],r)]),s.map(e.join)),reset:!0,backPressure:e.backPressure})},e.fromAtom=(e,t)=>(t=d("atom",Object.assign({emitFirst:!0,changed:(e,t)=>e!==t},t)),new w(s=>(e.addWatch(s.id,(e,r,i)=>{t.changed(r,i)&&s.next(i)}),t.emitFirst&&s.next(e.deref()),()=>e.removeWatch(s.id)),t)),e.fromDOMEvent=(e,t,s=!1,r)=>L(e,t,s,r),e.fromEvent=L,e.fromInterval=R,e.fromIterable=O,e.fromIterableSync=(e,t)=>new w(t=>{for(let s of e)t.next(s);0!==t.closeIn&&t.done()},d("iterable-sync",t)),e.fromPromise=y,e.fromPromises=(e,t)=>y(Promise.all(e),d("promises",t)).transform(s.mapcat(e=>e)),e.fromRAF=D,e.fromView=(e,t)=>(t=d("view",t),new w(s=>{let r=!0;const i=t.tx,n=new c.View(e,t.path,i?e=>r&&(e=i(e),s.next(e),e):e=>r&&(s.next(e),e),!1,t.equiv);return()=>{r=!1,n.release()}})),e.fromWorker=(t,s)=>{const r=g(t);return s=d("worker",s),new w(t=>{const i=e=>{t.next(e.data)},n=e=>{t.error(e.data)};return r.addEventListener("message",i),r.addEventListener("error",n),()=>{r.removeEventListener("message",i),r.removeEventListener("error",n),!1!==s.terminate&&(e.LOGGER.info("terminating worker",r),r.terminate())}},s)},e.inlineWorker=e=>g(new Blob([e],{type:"text/javascript"})),e.joinBuffer=e=>e?t=>[...s.mapcat(e,t)]:e=>Array.prototype.concat.apply([],e),e.makeWorker=g,e.merge=e=>new E(e),e.metaStream=(e,t)=>new I(e,t),e.nextID=l,e.optsWithID=d,e.postWorker=(t,s=!1,i=0)=>{const n=g(t);return{next(e){if(e instanceof Promise)return void e.then(e=>this.next(e));let t;if(s){const s=r.isTypedArray(e);(s||r.isTransferable(e))&&(t=[s?e.buffer:e])}n.postMessage(e,t||[])},done(){i>0&&setTimeout(()=>{e.LOGGER.info("terminating worker..."),n.terminate()},i)}}},e.pubsub=e=>new S(e),e.resolve=e=>new A(e),e.setLogger=t=>e.LOGGER=t,e.sidechainPartition=(e,t)=>new T(e,t),e.sidechainToggle=(e,t)=>new M(e,t),e.stream=function(e,t){return new w(e,t)},e.subscription=b,e.sync=f,e.timeout=(e,t)=>new j(e,t),e.trace=e=>({next(t){e?console.log(e,t):console.log(t)},done(){e?console.log(e,"done"):console.log("done")},error(t){e?console.log(e,"error",t):console.log("error",t)}}),e.transduce=(e,t,r,i)=>{let n,o=void 0!==i?i:r[0]();return new Promise((i,c)=>{n=e.subscribe({next(e){const t=r[2](o,e);s.isReduced(t)?i(t.deref()):o=t},done(){i(o)},error(e){c(e)}},t)}).then(e=>(n.unsubscribe(),e),e=>{throw n.unsubscribe(),e})},e.trigger=function(e=!0){return O([e],d("trigger"))},e.tunnel=v,e.tween=k,e.tweenNumber=(e,t=0,s=.05,r=.001,i)=>k(e,t,(e,t)=>e+(t-e)*s,(e,t)=>Math.abs(e-t)<r,i),Object.defineProperty(e,"__esModule",{value:!0})}));