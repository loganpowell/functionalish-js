!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@thi.ng/dcons"),require("@thi.ng/arrays"),require("@thi.ng/checks"),require("@thi.ng/errors"),require("@thi.ng/transducers")):"function"==typeof define&&define.amd?define(["exports","@thi.ng/dcons","@thi.ng/arrays","@thi.ng/checks","@thi.ng/errors","@thi.ng/transducers"],e):e(((t=t||self).thi=t.thi||{},t.thi.ng=t.thi.ng||{},t.thi.ng.csp={}),t.thi.ng.dcons,t.thi.ng.arrays,t.thi.ng.checks,t.thi.ng.errors,t.thi.ng.transducers)}(this,(function(t,e,s,i,r,n){"use strict";var o;(o=t.State||(t.State={}))[o.OPEN=0]="OPEN",o[o.CLOSED=1]="CLOSED",o[o.DONE=2]="DONE";class h{constructor(t=1){this.buf=new e.DCons,this.limit=t}get length(){return this.buf.length}isEmpty(){return 0===this.buf.length}isFull(){return this.buf.length>=this.limit}release(){return this.buf.release()}push(t){return!this.isFull()&&(this.buf.push(t),!0)}drop(){if(!this.isEmpty())return this.buf.drop()}}var l=function(t,e,s,i){return new(s||(s=Promise))((function(r,n){function o(t){try{l(i.next(t))}catch(t){n(t)}}function h(t){try{l(i.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,h)}l((i=i.apply(t,e||[])).next())}))};class u{constructor(...t){let s,n,o,l,[a,f]=t;switch(t.length){case 0:break;case 1:"string"==typeof a?s=a:d(a)?n=a:o=a;break;case 2:"string"==typeof a?(s=a,d(f)?n=f:o=f):[o,l]=t;break;case 3:i.isFunction(t[1])&&i.isFunction(t[2])?[s,o,l]=t:[s,n,o]=t;break;case 4:[s,n,o,l]=t;break;default:r.illegalArity(t.length)}this.id=s||`chan-${u.NEXT_ID++}`,n=n||1,this.buf="number"==typeof n?new h(n):n,this.writes=new e.DCons,this.reads=new e.DCons,this.txbuf=new e.DCons,this.tx=o?o(u.RFN):null,this.onerror=o&&(l||c),this.state=0,this.isBusy=!1}static constantly(t,e){const s=new u(e?n.delayed(e):null);return s.produce(()=>t),s}static repeatedly(t,e){const s=new u(e?n.delayed(e):null);return s.produce(t),s}static cycle(t,e){return u.from(n.cycle(t),e?n.delayed(e):null)}static range(...t){const[e,s,i,r]=t;return u.from(n.range(e,s,i),void 0!==r?n.delayed(r):null)}static timeout(t){const e=new u(`timeout-${u.NEXT_ID++}`);return setTimeout(()=>e.close(),t),e}static sleep(t){return u.timeout(t).read()}static fromPromise(t){const e=new u;return t.then(t=>(()=>l(this,void 0,void 0,(function*(){return yield e.write(t),yield e.close(),t})))()),e}static from(...t){let e,s;switch(t.length){case 1:break;case 2:"boolean"==typeof t[1]?e=t[1]:s=t[1];break;case 3:s=t[1],e=t[2];break;default:r.illegalArity(t.length)}const i=new u(s);return i.into(t[0],e),i}static select(t){return new Promise(e=>{const i=()=>{for(let i of s.shuffle(t))if(i.isReadable()||i.isClosed())return void i.read().then(t=>e([t,i]));u.SCHEDULE.call(null,i,0)};u.SCHEDULE.call(null,i,0)})}static merge(t,e,s=!0,i=!1){return e=e||new u,(()=>{l(this,void 0,void 0,(function*(){for(;;){let[r,n]=yield u.select(t);if(void 0===r){if(t.splice(t.indexOf(n),1),!t.length){s&&(yield e.close());break}}else yield e.write(i?[n.id,r]:r)}}))})(),e}static mergeTuples(t,e,s=!0,i=!0){return e=e||new u,(()=>{l(this,void 0,void 0,(function*(){let r=[],n=[...t],o=new Set(t),h=t.length;for(;;){let[i,l]=yield u.select([...o]),c=n.indexOf(l);if(void 0===i){if(s||1===t.length)break;t.splice(c,1)}r[c]=i,o.delete(l),0==--h&&(yield e.write(r),r=[],h=t.length,o=new Set(t))}i&&(yield e.close())}))})(),e}channel(){return this}write(t){return new Promise(e=>{if(0!==this.state&&e(!1),!(this.writes.length<u.MAX_WRITES))throw new Error(`channel stalled (${u.MAX_WRITES} unprocessed writes)`);this.writes.push({value:this.tx?()=>l(this,void 0,void 0,(function*(){try{n.isReduced(this.tx[2](this.txbuf,t))&&(this.state=1)}catch(e){this.onerror(e,this,t)}})):()=>t,resolve:e}),this.process()})}read(){return new Promise(t=>{2===this.state&&t(),this.reads.push(t),this.process()})}tryRead(t=1e3){return new Promise(e=>{(()=>{l(this,void 0,void 0,(function*(){return e((yield u.select([this,u.timeout(t)]))[0])}))})()})}close(t=!1){if(0===this.state)return this.state=1,t&&this.flush(),this.process()}isClosed(){return 0!==this.state}isReadable(){return 2!==this.state&&this.buf&&this.buf.length>0||this.writes&&this.writes.length>0||this.txbuf&&this.txbuf.length>0}consume(t=(t=>console.log(this.id,":",t))){return(()=>l(this,void 0,void 0,(function*(){let e;for(;void 0!==(e=null,e=yield this.read());)yield t(e)})))()}produce(t,e=!0){return(()=>l(this,void 0,void 0,(function*(){for(;!this.isClosed();){const s=yield t();if(void 0===s){e&&(yield this.close());break}yield this.write(s)}})))()}consumeWhileReadable(t=(t=>console.log(this.id,":",t))){return(()=>l(this,void 0,void 0,(function*(){let e;for(;this.isReadable()&&(e=yield this.read(),void 0!==e);)yield t(e),e=null})))()}reduce(t,e){return(()=>l(this,void 0,void 0,(function*(){const[s,i,r]=t;let o;for(e=null!=e?e:s();void 0!==(o=null,o=yield this.read());)if(e=r(e,o),n.isReduced(e)){e=e.deref();break}return n.unreduced(i(e))})))()}transduce(t,e,s){return(()=>l(this,void 0,void 0,(function*(){const i=t(e);return n.unreduced(i[1](yield this.reduce(i,s)))})))()}into(t,e=!0){return(()=>l(this,void 0,void 0,(function*(){for(let e of t){if(this.isClosed())break;yield this.write(e)}e&&(yield this.close())})))()}pipe(t,e=!0){return t instanceof u||(t=new u(t)),this.consume(e=>t.write(e)).then(()=>{e&&t.close()}),t}split(t,e,s,i=!0){return e instanceof u||(e=new u),s instanceof u||(s=new u),this.consume(i=>(t(i)?e:s).write(i)).then(()=>{i&&(e.close(),s.close())}),[e,s]}concat(t,e=!0){return(()=>l(this,void 0,void 0,(function*(){for(let e of t)yield e.consume(t=>this.write(t));e&&(yield this.close())})))()}release(){1===this.state&&(this.state=2,this.flush(),this.buf.release(),delete this.reads,delete this.writes,delete this.buf,delete this.txbuf,delete this.tx,delete this.isBusy,delete this.onerror)}process(){return l(this,void 0,void 0,(function*(){if(!this.isBusy){this.isBusy=!0;const t=this.reads,e=this.writes,s=this.buf,i=this.txbuf;let r=!0;for(;r;){for(;t.length&&(i.length||s.length);)if(i.length){const e=i.drop();void 0!==e&&t.drop()(e)}else{const e=yield s.drop().value();void 0!==e&&t.drop()(e)}for(;e.length&&!s.isFull();){const t=e.drop();s.push(t),t.resolve(!0)}if(1===this.state){if(this.tx&&!e.length)try{this.tx[1](this.txbuf)}catch(t){this.onerror(t,this)}if(!this.isReadable())return void this.release()}r=t.length&&(i.length||s.length)||e.length&&!s.isFull()}this.isBusy=!1}}))}flush(){let t;for(;t=this.reads.drop();)t();for(;t=this.writes.drop();)t.resolve(!1);this.buf.release()}}u.MAX_WRITES=1024,u.NEXT_ID=0,u.SCHEDULE="function"==typeof setImmediate?setImmediate:setTimeout,u.RFN=[()=>null,t=>t,(t,e)=>t.push(e)];const c=(t,e,s)=>console.log(e.id,"error occurred",t.message,void 0!==s?s:""),d=t=>t instanceof h||"number"==typeof t;var a=function(t,e,s,i){return new(s||(s=Promise))((function(r,n){function o(t){try{l(i.next(t))}catch(t){n(t)}}function h(t){try{l(i.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,h)}l((i=i.apply(t,e||[])).next())}))};class f{constructor(...t){let s,i;switch(this.tapID=0,t.length){case 2:s=t[0],i=t[1];break;case 1:"string"==typeof t[0]?s=t[0]:i=t[0];break;case 0:s="mult"+f.nextID++;break;default:r.illegalArity(t.length)}this.src=i instanceof u?i:new u(s,i),this.taps=new e.DCons,this.process()}get id(){return this.src&&this.src.id}set id(t){this.src&&(this.src.id=t)}channel(){return this.src}write(t){return this.src?this.src.write(t):Promise.resolve(!1)}close(t=!1){return this.src?this.src.close(t):void 0}tap(t){if(this.taps){if(t instanceof u){if(this.taps.find(t))return t}else t=new u(this.src.id+"-tap"+this.tapID++,t);return this.taps.push(t),t}}untap(t){if(this.taps){const e=this.taps.find(t);if(e)return this.taps.remove(e),!0}return!1}untapAll(t=!0){if(this.taps){let e=this.taps.head;for(;e;)t&&e.value.close(),this.taps.remove(e),e=e.next;return!0}return!1}process(){return a(this,void 0,void 0,(function*(){let t;for(;void 0!==(t=null,t=yield this.src.read());){let e=this.taps.head;for(;e;)(yield e.value.write(t))||this.taps.remove(e),e=e.next}for(let t of this.taps)yield t.close();delete this.src,delete this.taps,delete this.tapID}))}}f.nextID=0;var p=function(t,e,s,i){return new(s||(s=Promise))((function(r,n){function o(t){try{l(i.next(t))}catch(t){n(t)}}function h(t){try{l(i.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(o,h)}l((i=i.apply(t,e||[])).next())}))};class y{constructor(...t){switch(t.length){case 2:this.src=t[0],this.fn=t[1];break;case 1:this.src=new u("pubsub"+y.NEXT_ID++),this.fn=t[0];break;default:r.illegalArity(t.length)}this.topics={},this.process()}get id(){return this.src&&this.src.id}set id(t){this.src&&(this.src.id=t)}channel(){return this.src}write(t){return this.src?this.src.write(t):Promise.resolve(!1)}close(t=!1){return this.src?this.src.close(t):void 0}sub(t,e){let s=this.topics[t];return s||(this.topics[t]=s=new f(this.src.id+"-"+t)),s.tap(e)}unsub(t,e){let s=this.topics[t];return!!s&&s.untap(e)}unsubAll(t,e=!0){let s=this.topics[t];return!!s&&s.untapAll(e)}process(){return p(this,void 0,void 0,(function*(){let t;for(;void 0!==(t=null,t=yield this.src.read());){const e=yield this.fn(t);let s=this.topics[e];s&&(yield s.write(t)),s=this.topics["*"],s&&(yield s.write(t))}for(let t of Object.keys(this.topics))this.topics[t].close();delete this.src,delete this.topics,delete this.fn}))}}y.NEXT_ID=0,t.Channel=u,t.DroppingBuffer=class extends h{constructor(t=1){super(t)}isFull(){return!1}push(t){return this.buf.length<this.limit&&this.buf.push(t),!0}},t.FixedBuffer=h,t.Mult=f,t.PubSub=y,t.SlidingBuffer=class extends h{constructor(t=1){super(t)}isFull(){return!1}push(t){return this.buf.length>=this.limit&&this.buf.drop(),this.buf.push(t),!0}},Object.defineProperty(t,"__esModule",{value:!0})}));